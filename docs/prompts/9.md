# Phase 3 — Hard QA Findings and Fix Plan

This doc lists concrete issues found in the current repo, why they matter, and exactly how to fix them.

You are Claude Code. Read this document and then:
- Propose a concise plan (max 8 steps) for the Minimal Patch Set below.
- Show diffs before applying.
- Apply changes.
- Provide run/validation instructions and a manual QA checklist.
- Stop after validation output for review.

## High‑Value Quick Fixes
- Start screen image path
- Particle config name mismatches
- Pool size bug in `EntityManager`
- Hard‑coded bullet speed duplicate

---

## 1) Broken References (Start Screen)
- Where: `src/framework/components/overlays/StartScreen.tsx`
- What: Background uses `/assets/images/startbg.jpg` which doesn’t exist. Available asset: `src/assets/start_screen.png`.
- Why: Causes 404 and broken start overlay background.
- Fix:
  - Replace the `src` with an ESM URL import that works in Vite and builds:
    - Change to: `src={new URL('../../../assets/start_screen.png', import.meta.url).toString()}`
    - Alternative acceptable: `'/src/assets/start_screen.png'` (dev only)
- Acceptance: Image renders on start overlay without network error.

## 2) Particle Emitter Name Mismatches
- Where (emit callers):
  - `src/framework/game/Game.tsx` → `muzzle_flash`
  - `src/framework/systems/CollisionSystem.ts` → `sparks`, `explosion_medium`, `sparkle`
  - `src/framework/systems/WaveSystem.ts` → `fireworks`, `explosion_large`, `sparkle`
  - `src/framework/systems/ScoringSystem.ts` → `sparkle`, `fireworks`
- What: These names aren’t present in `ParticleSystem` configs.
- Why: No‑op emissions with warnings; missing VFX.
- Fix (best approach with zero duplication):
  - Add a static alias map and resolve aliases in `emit`:
```
  // In ParticleSystem class
  private static readonly ALIASES: Record<string, string> = {
    muzzle_flash: 'ship_muzzle_flash',
    explosion_large: 'asteroid_explosion_large',
    explosion_medium: 'asteroid_explosion_medium',
  };

  public emit(configName: string, position: THREE.Vector3, direction?: THREE.Vector3): void {
    const key = ParticleSystem.ALIASES[configName] ?? configName;
    const config = ParticleSystem.EMITTER_CONFIGS[key];
    if (!config) { console.warn(`Unknown particle config: ${configName}`); return; }
    // ... existing logic
  }
```
  - Add new configs inside `EMITTER_CONFIGS` for:
```
    sparkle: { type: 'sparkle', count: 14, position: new THREE.Vector3(),
      velocity: { min: new THREE.Vector3(-20,-20,0), max: new THREE.Vector3(20,20,0) },
      size: { min: 0.8, max: 2.8 }, life: { min: 0.4, max: 0.9 },
      color: { start: new THREE.Color(0.8,1,1), end: new THREE.Color(0.4,0.8,1) },
      gravity: new THREE.Vector3(0,0,0), drag: 0.97, burst: true },

    sparks: { type: 'sparkle', count: 10, position: new THREE.Vector3(),
      velocity: { min: new THREE.Vector3(-30,-10,0), max: new THREE.Vector3(30,40,0) },
      size: { min: 0.6, max: 2.2 }, life: { min: 0.2, max: 0.6 },
      color: { start: new THREE.Color(1,0.9,0.6), end: new THREE.Color(1,0.6,0.2) },
      gravity: new THREE.Vector3(0,-10,0), drag: 0.95, burst: true },

    fireworks: { type: 'explosion', count: 18, position: new THREE.Vector3(),
      velocity: { min: new THREE.Vector3(-60,-60,0), max: new THREE.Vector3(60,60,0) },
      size: { min: 2, max: 5 }, life: { min: 0.8, max: 1.8 },
      color: { start: new THREE.Color(1,0.9,0.6), end: new THREE.Color(0.6,0.8,1) },
      gravity: new THREE.Vector3(0,-5,0), drag: 0.98, burst: true },
```
- Acceptance: No “Unknown particle config” warnings; expected effects visible on shoot, hits, explosions, wave events.

## 3) Pool Size Check Bug (EntityManager)
- Where: `src/framework/systems/EntityManager.ts` in `cleanupCollection`
- What: Compares `pool.length < EntityManager.POOL_SIZES.ships` for all types.
- Why: Incorrect pool refill thresholds for non‑ship pools (asteroids, bullets, etc.).
- Fix:
  - Add `ships: 5` to `POOL_SIZES` in `src/framework/constants/gameConstants.ts`.
  - Remove local `POOL_SIZES` from `EntityManager` and import from constants.
  - Replace the hardcoded ships size check with a per‑collection threshold.
  - Concrete change outline in `EntityManager.ts`:
```
  import { POOL_SIZES, BULLET } from '../constants/gameConstants';

  private cleanupCollection<T extends BaseEntity>(entities: T[], pool: T[], kind: keyof EntityCollections): void {
    for (let i = entities.length - 1; i >= 0; i--) {
      const entity = entities[i];
      if (!entity.active) {
        this.removeEntity(entity);
        entities.splice(i, 1);
        if (pool.length < POOL_SIZES[kind]) {
          pool.push(entity);
        }
      }
    }
  }

  // Call with kind per collection
  this.cleanupCollection(this.entities.ships, this.shipPool, 'ships');
  this.cleanupCollection(this.entities.asteroids, this.asteroidPool, 'asteroids');
  this.cleanupCollection(this.entities.bullets, this.bulletPool, 'bullets');
  this.cleanupCollection(this.entities.enemies, this.enemyPool, 'enemies');
  this.cleanupCollection(this.entities.pickups, this.pickupPool, 'pickups');
```
- Acceptance: Cleanup uses correct threshold per collection; no unintended pool growth/shrink.

## 4) Hard‑Coded Bullet Speed
- Where: `src/framework/systems/EntityManager.ts` in `spawnBullet`
- What: Uses `Math.cos/sin(direction) * 70` with comment `// BULLET.speed = 70`.
- Why: Diverges if constants change; magic number.
- Fix: Import `BULLET` and use `BULLET.speed` instead of `70` within `spawnBullet` and any bullet velocity setup.
- Acceptance: Compiles; bullet behavior unchanged; no magic number.

## 5) Game State Naming/Consistency
- Where:
  - Hook state type `GameState`: `src/framework/hooks/useGameState.ts`
  - Manager state union `GameState`: `src/framework/systems/GameStateManager.ts`
- What: Same name used for different concepts (full state vs. phase/union).
- Why: Type collisions/confusion in imports and code reviews.
- Fix: Defer to a follow‑up patch (out of minimal scope). Note this as a tracked task.
- Acceptance: Types compile; all imports explicit; no ambiguity.

## 6) Overlay Type Casing Mismatch
- Where:
  - Overlay values include `'gameover'`: `src/framework/constants/gameConstants.ts`
  - Manager uses `'gameOver'`: `src/framework/systems/GameStateManager.ts`
- What: Inconsistent casing.
- Why: Logic/conditional mismatches; overlays not toggling reliably.
- Fix: Defer to a follow‑up patch. Keep minimal set risk‑free.
- Acceptance: Overlay routing consistent in UI tests and `Game` component.

## 7) Duplicate UI Systems (Decide Source of Truth)
- Where:
  - Framework components: `src/framework/components/*` with `OverlayManager`, `HUDManager`, themed CSS
  - Separate UI set: `src/framework/ui/*` with `HUD`, `MainMenu`, `GameOver`, `PauseMenu`
- What: Two parallel UI layers.
- Why: Maintenance overhead; mixed imports (`Game.tsx` imports from `../ui` while `GameFramework` uses `./components`).
- Fix: Defer consolidation to a separate pass once gameplay loops are solid.
- Acceptance: One UI system referenced everywhere; no dead duplicate.

## 8) Unused Utilities and Hooks
- Where:
  - `src/framework/utils/collisionUtils.ts` not imported anywhere.
  - `useEntityPool` advanced sections are not wired into gameplay/tests.
- Why: Dead code/confusion.
- Fix: Defer removal. Add a short top‑of‑file comment in `collisionUtils.ts` marking it internal/unused for now; plan integration or removal later.
- Acceptance: No unused files unless intentionally kept and documented.

## 9) Asset Path Robustness (Ship Texture)
- Where: `src/framework/entities/Ship.ts`
- What: Loads `'/src/assets/ship/ship.png'` via `TextureLoader`.
- Why: Absolute dev path works in Vite but can be brittle; better to use ESM URL.
- Fix: `const url = new URL('../../assets/ship/ship.png', import.meta.url); loader.load(url.toString(), ...)`.
- Acceptance: Texture loads in dev/prod; no 404 warnings.

## 10) Constants Duplication / Drift Risks
- Where:
  - Pool sizes defined locally: `src/framework/systems/EntityManager.ts`
  - Also defined in `src/framework/constants/gameConstants.ts::POOL_SIZES`
- What: Duplicate definitions may drift.
- Fix: Source all pool sizes from `gameConstants.ts` (single source of truth) and delete local `POOL_SIZES`.
- Acceptance: Compiles; behavior unchanged.

## 11) Renderer Settings Consistency
- Where:
  - `useThreeScene.ts` sets `renderer.outputColorSpace = THREE.SRGBColorSpace` and tone mapping directly
  - `RENDERER_SETTINGS` contains string values for these
- What: Mixed sources; potential drift.
- Fix: Defer larger refactor. Keep hook authoritative. Add comment in `gameConstants.ts` noting these keys are informative and hooked settings live in `useThreeScene`.
- Acceptance: One authoritative source; no dead config keys.

## 12) Entities API Consistency
- Where: `EntityManager.getEntitiesOfType` only includes ships/asteroids/bullets.
- What: Enemies/pickups excluded.
- Why: API surprises for callers expecting all collections.
- Fix: Include all collections in `getEntitiesOfType` by building an array of all entity arrays via `Object.values(this.entities)` and flattening, or document the limitation via JSDoc. Prefer inclusion for flexibility.
- Acceptance: Clear contract; callers behave as expected.

## 13) TODOs (Dropped/Incomplete Work)
- Where:
  - `src/game/GameScene.tsx` — TODOs for entities, collisions, pickups, wave completion
  - `src/framework/systems/WaveSystem.ts` — enemy spawning integration
  - `src/framework/entities/Enemy.ts` — shooting integration
  - `src/framework/components/hud/Minimap.tsx` — render entities on minimap
  - `src/framework/systems/ScoringSystem.ts` — custom particle colors/popups
- Fix: Track these as tasks; implement per Phase 3 plan.
- Acceptance: TODOs retired with working features, or annotated with clear owner/scope.

## 14) ORE_RATES Comments vs Values
- Where: `src/framework/constants/gameConstants.ts`
- What: Values and comments don’t align (e.g., `gold: 0.97` with comment “2.5% chance”).
- Why: Misleading documentation.
- Fix: Correct comments to match values or adjust values to target probabilities.
- Acceptance: Comments accurately describe the values.

---

## Proposed Minimal Patch Set (Safe, Low‑Risk)
1) Fix StartScreen image path.
2) ParticleSystem: add alias resolution in `emit` and new configs (`sparkle`, `sparks`, `fireworks`).
3) EntityManager: import `POOL_SIZES` and `BULLET`; remove local `POOL_SIZES`; fix per‑collection threshold; use `BULLET.speed`.
4) Extend `getEntitiesOfType` to include enemies and pickups.

After: run dev, verify start overlay image, shoot/muzzle flash renders, explosions/sparks on collisions, no unknown particle warnings, entity pools stable.

## Validation Checklist (post‑patch)
- No console warnings for unknown particle configs.
- Start overlay background loads successfully.
- Shooting shows muzzle flash; asteroid hits show sparks/explosion; wave start/complete show effects.
- Pools report stable counts in `EntitySystemTest` debug panel.
- No TypeScript errors from renamed overlay type (if changed).

## Stretch (Optional Follow‑Ups)
- Unify UI systems (choose `components/*` or `ui/*`).
- Rename `GameStateManager` union type to `GamePhase` and update imports.
- Switch ship texture to `new URL(..., import.meta.url)`.
- Remove or wire up unused utils/hooks/assets.

Please propose diffs for the “Minimal Patch Set” first and pause for review.

---

# CC Execution Details

## Objective
Implement the Minimal Patch Set safely with tight, localized diffs and no API regressions.

## Scope
- Only change these files:
  - `src/framework/components/overlays/StartScreen.tsx`
  - `src/framework/systems/ParticleSystem.ts`
  - `src/framework/systems/EntityManager.ts`
  - `src/framework/constants/gameConstants.ts` (comments only if needed)
  - `src/framework/systems/GameStateManager.ts` and `src/framework/game/Game.tsx` if aligning overlay casing or `GamePhase` naming.

## Constraints
- Do not refactor unrelated systems.
- Keep public exports stable unless explicitly noted (e.g., `GamePhase` rename).
- Maintain existing visual behavior where possible; the particle configs should be conservative.

## Plan (suggested 5 steps)
1) StartScreen: fix image path using ESM URL.
2) ParticleSystem: add alias resolution and `sparkle`/`sparks`/`fireworks` configs.
3) EntityManager: import `POOL_SIZES`/`BULLET`, remove local pool sizes, fix per‑collection check, replace hard‑coded speed.
4) Entities API: extend `getEntitiesOfType` to include enemies/pickups.
5) Comments: add notes to `RENDERER_SETTINGS` and `collisionUtils.ts` per above to prevent confusion.

## Diffs Preview
- Show a unified diff for each edited file, with clear anchors around modified blocks.
- Call out any risky changes.

## Apply and Validate
- After apply, provide:
  - Commands: `npm install` (if needed), `npm run dev`.
  - Manual test script:
    - Load app → Start screen shows background image (no 404 in console).
    - Enter EntitySystemTest (key `1` in `src/game/App.tsx`):
      - Spawn ship; move with W/S and mouse aim; Space to shoot → see muzzle flash.
      - Spawn asteroid; shoot it → sparks and explosion appear; no warnings for particle configs.
      - Watch pools in debug panel; counts stable; no pool exhaustion logs.
    - Play Complete Game (key `3`):
      - Start game; wave start/complete should show fireworks/explosion effects; no warnings.
  - List any follow‑up TODOs discovered.
