# Asteroids+ React Port – Definitive Fix Plan (Parities + Enhancements)

Goal: Bring the React port to parity with the vanilla reference (`reference/vanillaHTML/`) and implement Asteroids+ upgrades (mouse aim, W/S thrust, shop cadence, bosses, minimap, etc.). This document specifies WHAT to change and WHERE to change it with clear acceptance criteria.

Note: Keep changes small and localized. Show diffs before apply, then commit and push (footer).

---

## 1) Controls and Feel

- Files:
  - `src/framework/game/Game.tsx`
  - `src/framework/entities/Ship.ts`

- Implement:
  - Mouse aim (world-space conversion) when no A/D pressed; A/D overrides while held.
  - W = forward thrust; S = reverse thrust at ~0.65 × forward power.

- Details (Game.tsx):
  - In input handlers, track `mousePos` and on RAF compute world coords using camera:
    - `nx = (mouseX/rect.width)*2 - 1`, `ny = -((mouseY/rect.height)*2 - 1)`
    - `worldX = nx * (cam.right - cam.left) / 2 + cam.position.x`
    - `worldY = ny * (cam.top - cam.bottom) / 2 + cam.position.y`
    - `angle = Math.atan2(worldX - ship.position.x, worldY - ship.position.y)`
  - In `updateShipControls`:
    - If A or D pressed → `ship.setRotating(-1|1)` and do not apply mouse aim.
    - Else → `ship.setTargetRotation(angle)` and `ship.setRotating(0)`.
    - Thrust: W → `ship.setThrusting(true)`; S → apply reverse thrust flag (see below).
  - In `Ship.ts` add support for reverse thrust: if `this.thrustingReverse` set, apply thrust against forward vector with multiplier 0.65.

- Acceptance:
  - Ship nose smoothly tracks mouse when A/D not pressed; A/D rotates while held.
  - W accelerates forward, S accelerates backward weaker; inertia feels like reference.

---

## 2) Shooting + Bullet Distance

- Files:
  - `src/framework/game/Game.tsx`
  - `src/framework/constants/gameConstants.ts`
  - `src/framework/entities/Bullet.ts`

- Implement:
  - Space and left click fire; call `preventDefault()` on Space keydown (not keyup).
  - Bullets travel ≈ 1.5 × visible height: derive life instead of hardcoding.

- Details:
  - In Game.tsx keydown handler: if `e.code === gameSettings.controls.shoot` → `e.preventDefault()`.
  - In `gameConstants.ts` set: `export const BULLET = { speed: 70, life: (VISIBLE_HEIGHT * 1.5) / 70, r: 0.2 }` (or compute in Bullet if constants cannot depend on VISIBLE_HEIGHT; otherwise set numeric after calculation).

- Acceptance:
  - Space and left click shoot reliably; page does not scroll.
  - Bullets live long enough to cross ≈1.5× visible area at current speed.

---

## 3) Camera Follow + Continuous Render

- Files:
  - `src/framework/game/Game.tsx`
  - `src/framework/hooks/useThreeScene.ts`

- Implement:
  - After ship spawn: `threeScene.setCameraFollow(ship.mesh!)`.
  - Keep a single RAF loop that always calls `threeScene.update(dt, { paused, gameOver })` and `composer.render()` in all states (menu, playing, paused). Cancel RAF on unmount.

- Acceptance:
  - Starfield visible at menu; camera smoothly tracks the ship during gameplay.

---

## 4) Minimap – Full WORLD + Viewport + Toggle

- Files:
  - `src/framework/components/hud/Minimap.tsx`
  - `src/framework/game/Game.tsx`

- Implement:
  - Minimap shows the entire WORLD extents; always-on transform:
    - Normalize: `nx = (x + WORLD.width/2) / WORLD.width`
    - `ny = 1 - (y + WORLD.height/2) / WORLD.height`
    - Pixels: `px = nx * width`, `py = ny * height`
  - Render ship (bright), asteroids (gray sized by sizeKey), bullets (yellow tiny).
  - Draw viewport rectangle using camera center `(cx, cy)` and frustum `(camW, camH)`.
  - Pass optional `entityManager` and `viewport` from `Game.tsx` to Minimap. Guard when absent (menu).
  - Add `[Tab]` toggle in `Game.tsx` to switch minimap opacity 0.1 ↔ 1.0 during gameplay; avoid consuming Tab in menus or inputs.

- Acceptance:
  - Minimap positions and viewport box reflect the world and camera in real time; Tab toggles opacity.

---

## 5) Wave Spawning – Off‑Map Inbound + Cadence

- Files:
  - `src/framework/systems/WaveSystem.ts`
  - `src/framework/game/Game.tsx`

- Implement:
  - Spawn asteroids just outside WORLD bounds with slight inward velocity (base speed ≈ `ASTEROIDS.baseSpeed`, jitter ±40%).
  - Add logging: wave start and `spawnWave` counts for quick QA.
  - On wave complete: every other wave open Hangar/Shop overlay; otherwise auto-start next wave after a short delay (e.g., 1.5–2.0s).

- Details:
  - Off‑map spawn: pick side (top/bottom/left/right), choose random coordinate along that edge, position at WORLD bound ± margin (10–20 units), velocity pointing inward plus random tangential component.
  - In `Game.tsx`, handle WaveSystem callbacks to open overlay: set overlay `'hangar'`, pause gameplay.

- Acceptance:
  - Asteroids enter play from outside boundaries; hangar opens at waves 2, 4, 6, …; resume continues gameplay correctly.

---

## 6) Hangar/Shop – Wiring + Assets

- Files:
  - `src/framework/components/overlays/HangarScreen.tsx`
  - `src/framework/components/OverlayManager.tsx`
  - `src/framework/hooks/useGameState.ts` (currency + upgrades)
  - `src/framework/data/upgradeDefinitions.ts`

- Implement:
  - Fix hangar background path (use ESM URL to `/src/assets/Hanger.png`).
  - When overlay `'hangar'` opens, display player currencies from game state.
  - Minimal shop inventory: 3 upgrade options from definitions; reroll button refreshes; banish hides one option. Purchase decrements currency and applies `applyUpgrade`.

- Acceptance:
  - Hangar shows after every other wave with correct background; upgrades purchasable with currency; close proceeds to next wave.

---

## 7) Currency Drops + Magnet Pickup

- Files:
  - `src/framework/systems/CollisionSystem.ts`
  - `src/framework/entities/Pickup.ts`
  - `src/framework/hooks/useGameState.ts`

- Implement:
  - On asteroid destruction: spawn salvage pickups (and occasional higher-tier) using weighted rates similar to reference (see `ORE_RATES`/`PICKUP_RATES` in `gameConstants.ts`).
  - Set ship as magnet target for spawned pickups.
  - On pickup apply: increment currency in game state (replace console logs) and play SFX/VFX.

- Acceptance:
  - Salvage spawns on kills and vacuums to ship; currency increments visible in HUD; no console spam.

---

## 8) Boss Waves (every 5 waves)

- Files:
  - `src/framework/entities/Boss.ts` (new)
  - `src/framework/systems/WaveSystem.ts`
  - `src/framework/systems/CollisionSystem.ts` (boss death effects)

- Implement:
  - Create simple Boss entity (plane with boss texture from `src/assets/boss/*.png`), basic chase AI (no shooting), health scaling by boss number.
  - In WaveSystem, on every 5th wave: spawn one boss instead of (or in addition to fewer) asteroids; mark wave complete on boss death.
  - On death: explosion effects, debris, score bonus, and a loot burst (multiple pickups).

- Acceptance:
  - Boss appears on wave 5, 10, …; chases player; defeating it completes the wave and drops extra loot.

---

## 9) Scoring and Feedback

- Files:
  - `src/framework/systems/CollisionSystem.ts`
  - `src/framework/systems/ScoringSystem.ts`

- Implement:
  - On asteroid/boss kills: call ScoringSystem to add points and update combo timer; emit particle popups (sparkle/fireworks already configured) and small camera shake.

- Acceptance:
  - Score increases on kills; combo UI behaves; subtle feedback present.

---

## 10) Assets and Paths (quick fixes)

- Files:
  - `src/framework/components/overlays/StartScreen.tsx`
  - `src/framework/components/overlays/HangarScreen.tsx`

- Implement:
  - Replace hardcoded `/assets/images/...` with ESM URL imports:
    - `new URL('../../../assets/start_screen.png', import.meta.url).toString()`
    - `new URL('../../../assets/Hanger.png', import.meta.url).toString()`

- Acceptance:
  - Background images load without 404s.

---

## 11) Loop Integrity and State

- Files:
  - `src/framework/game/Game.tsx`
  - `src/framework/hooks/useThreeScene.ts`

- Implement:
  - Ensure a single RAF loop in Game.tsx; cancel on unmount to avoid conflicts with test modes.
  - Keep `threeScene.update(dt)` + `composer.render()` running in all states.

- Acceptance:
  - No double loops; consistent rendering in menu and gameplay.

---

## Validation – Manual QA Script

1) Start app; confirm Start screen with buttons; Press Start → ship spawns; starfield visible.
2) Mouse aim: ship nose tracks cursor; A/D overrides rotate while held.
3) W/S thrust: forward vs. weaker reverse; momentum persists; Space/left click fires without page scroll.
4) Bullets travel ≈ 1.5× visible height; muzzle flash/explosion effects present.
5) Asteroids spawn from outside WORLD and drift inward; wrapping is seamless; minimap shows full world and viewport box (Tab toggles opacity).
6) Kill asteroids: salvage drops and vacuums; HUD currency increases.
7) Wave complete: every other wave opens Hangar; buy an upgrade; resume next wave.
8) Wave 5: boss spawns, chases player; killing boss completes wave and drops extra loot.
9) Performance: stable ~60 FPS; no console spam.

---

## Commit and Push

After applying and validating the changes, commit and push:

- Commit message:
  - `feat(game): parity + upgrades — mouse aim, W/S thrust, bullet range, off‑map spawns, hangar cadence, minimap, currency drops, bosses, camera follow, asset fixes`

- Push:
  - `git push`

